<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>أداة تنظيف ومراجعة JSON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .file-list-item, .modal-row {
            transition: all 0.3s ease;
        }
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-lg p-8 relative">
        <!-- زر تبديل اللغة -->
        <div class="absolute top-4 left-4">
            <button id="lang-toggle-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow hover:bg-gray-300 transition-colors duration-300">
                English
            </button>
        </div>

        <div class="text-center mb-8">
            <h1 id="main-title" class="text-3xl font-bold text-gray-800">أداة تنظيف ومراجعة إجابات JSON</h1>
            <p id="main-description" class="text-gray-600 mt-2">
                قم برفع ملفات JSON لإزالة وسوم HTML من إجابات أسئلة النوع "string" ومراجعتها قبل التحميل.
            </p>
        </div>

        <!-- منطقة رفع الملفات -->
        <div id="upload-area" class="border-4 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-500 transition-colors duration-300">
            <input type="file" id="file-input" multiple accept=".json" class="hidden">
            <div id="upload-prompt">
                <svg class="mx-auto h-16 w-16 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="mt-4 text-lg text-gray-600">
                    <span id="upload-button-text" class="font-semibold text-blue-600">انقر للاختيار</span> <span id="upload-drag-text">أو قم بسحب وإفلات الملفات هنا</span>
                </p>
                <p id="upload-hint" class="text-sm text-gray-500 mt-1">يجب أن تكون الملفات بصيغة JSON</p>
            </div>
        </div>

        <!-- منطقة عرض النتائج والأزرار -->
        <div id="results-area" class="mt-8 hidden">
            <h2 id="files-header" class="text-xl font-semibold text-gray-700 mb-4">الملفات المرفوعة:</h2>
            <div id="file-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
            
            <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
                <button id="process-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all duration-300 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0L8 5.45a1.5 1.5 0 01-2.12 2.12L3.45 8c-1.56.38-1.56 2.6 0 2.98L5.45 12a1.5 1.5 0 01-2.12 2.12L8 16.55c.38 1.56 2.6 1.56 2.98 0L12 14.55a1.5 1.5 0 012.12-2.12l2.43-2.43c1.56-.38 1.56-2.6 0-2.98L14.55 8a1.5 1.5 0 01-2.12-2.12L11.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                    <span id="process-btn-text">معالجة</span>
                </button>
                <button id="validate-btn" class="w-full bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-yellow-600 transition-all duration-300 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                    <span id="validate-btn-text">مراجعة وتعديل</span>
                </button>
                <button id="download-btn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-all duration-300 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    <span id="download-btn-text">تحميل</span>
                </button>
            </div>
             <div id="processing-indicator" class="mt-4 text-center text-gray-600 hidden">
                <p id="processing-indicator-text">جاري المعالجة... يرجى الانتظار.</p>
            </div>
        </div>
    </div>

    <!-- شاشة المراجعة والتعديل -->
    <div id="validation-modal" class="fixed inset-0 modal-bg z-50 hidden items-center justify-center p-4">
        <div class="w-full max-w-6xl bg-white rounded-2xl shadow-lg flex flex-col" style="height: 90vh;">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800">مراجعة وتعديل الملفات</h2>
                <button id="close-modal-btn" class="text-gray-500 hover:text-red-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto p-4">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100">
                            <th id="modal-header-filename" class="p-3 text-right font-semibold text-gray-700 border-b">اسم الملف</th>
                            <th id="modal-header-original" class="p-3 text-right font-semibold text-gray-700 border-b">الإجابة الأصلية (HTML)</th>
                            <th id="modal-header-cleaned" class="p-3 text-right font-semibold text-gray-700 border-b">الإجابة الجديدة (قابلة للتعديل)</th>
                        </tr>
                    </thead>
                    <tbody id="validation-table-body">
                        <!-- سيتم ملء الصفوف هنا بواسطة JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="p-4 border-t text-left">
                 <button id="modal-close-save-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-all duration-300">
                    <span id="modal-close-save-btn-text">إغلاق</span>
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- تعريف العناصر ---
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const resultsArea = document.getElementById('results-area');
        const fileList = document.getElementById('file-list');
        const processBtn = document.getElementById('process-btn');
        const validateBtn = document.getElementById('validate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const uploadPrompt = document.getElementById('upload-prompt');
        const processingIndicator = document.getElementById('processing-indicator');
        const langToggleBtn = document.getElementById('lang-toggle-btn');
        const validationModal = document.getElementById('validation-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalCloseSaveBtn = document.getElementById('modal-close-save-btn');
        const validationTableBody = document.getElementById('validation-table-body');
        
        let uploadedFiles = [];
        let processedFilesData = []; // لتخزين بيانات المعالجة للمراجعة
        let currentLang = localStorage.getItem('jsonCleanerLang') || 'ar';

        // --- قاموس الترجمة ---
        const translations = {
            ar: {
                title: "أداة تنظيف ومراجعة إجابات JSON",
                description: "قم برفع ملفات JSON لإزالة وسوم HTML من إجابات أسئلة النوع \"string\" ومراجعتها قبل التحميل.",
                filesHeader: "الملفات المرفوعة:",
                uploadButton: "انقر للاختيار",
                uploadDrag: "أو قم بسحب وإفلات الملفات هنا",
                uploadHint: "يجب أن تكون الملفات بصيغة JSON",
                processButton: "معالجة",
                validateButton: "مراجعة وتعديل",
                downloadButton: "تحميل",
                processingStatus: "جاري المعالجة... يرجى الانتظار.",
                readyStatus: "جاهز للمعالجة",
                processingFileStatus: "جاري المعالجة...",
                cleanedStatus: "تم التنظيف بنجاح",
                noChangesStatus: "لم يتم العثور على تغييرات",
                errorStatus: "خطأ",
                fileReadError: "خطأ في قراءة الملف",
                invalidJsonError: "ملف JSON غير صالح",
                processingComplete: "اكتملت المعالجة! يمكنك الآن المراجعة أو التحميل.",
                processingError: "حدث خطأ أثناء المعالجة. يرجى مراجعة حالة الملفات.",
                langToggleButton: "English",
                alertOnlyJson: "الرجاء اختيار ملفات بصيغة JSON فقط.",
                modalTitle: "مراجعة وتعديل الملفات",
                modalHeaderFilename: "اسم الملف",
                modalHeaderOriginal: "الإجابة الأصلية (HTML)",
                modalHeaderCleaned: "الإجابة الجديدة (قابلة للتعديل)",
                modalCloseSave: "إغلاق"
            },
            en: {
                title: "JSON Answer Cleaner & Validator",
                description: "Upload, clean, and review JSON files by removing HTML tags from \"string\" type question answers before downloading.",
                filesHeader: "Uploaded Files:",
                uploadButton: "Click to select",
                uploadDrag: "or drag and drop files here",
                uploadHint: "Files must be in JSON format",
                processButton: "Process",
                validateButton: "Validate & Edit",
                downloadButton: "Download",
                processingStatus: "Processing... Please wait.",
                readyStatus: "Ready to process",
                processingFileStatus: "Processing...",
                cleanedStatus: "Cleaned successfully",
                noChangesStatus: "No changes found",
                errorStatus: "Error",
                fileReadError: "File read error",
                invalidJsonError: "Invalid JSON file",
                processingComplete: "Processing complete! You can now validate or download.",
                processingError: "An error occurred during processing. Please check the file statuses.",
                langToggleButton: "العربية",
                alertOnlyJson: "Please select JSON files only.",
                modalTitle: "Validate & Edit Files",
                modalHeaderFilename: "File Name",
                modalHeaderOriginal: "Original Answer (HTML)",
                modalHeaderCleaned: "New Answer (Editable)",
                modalCloseSave: "Close"
            }
        };

        // --- وظائف اللغة ---
        function updateLanguageUI() {
            const lang = translations[currentLang];
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('main-title').textContent = lang.title;
            document.getElementById('main-description').textContent = lang.description;
            document.getElementById('files-header').textContent = lang.filesHeader;
            document.getElementById('upload-button-text').textContent = lang.uploadButton;
            document.getElementById('upload-drag-text').textContent = lang.uploadDrag;
            document.getElementById('upload-hint').textContent = lang.uploadHint;
            document.getElementById('process-btn-text').textContent = lang.processButton;
            document.getElementById('validate-btn-text').textContent = lang.validateButton;
            document.getElementById('download-btn-text').textContent = lang.downloadButton;
            document.getElementById('processing-indicator-text').textContent = lang.processingStatus;
            langToggleBtn.textContent = lang.langToggleButton;
            document.getElementById('modal-title').textContent = lang.modalTitle;
            document.getElementById('modal-header-filename').textContent = lang.modalHeaderFilename;
            document.getElementById('modal-header-original').textContent = lang.modalHeaderOriginal;
            document.getElementById('modal-header-cleaned').textContent = lang.modalHeaderCleaned;
            document.getElementById('modal-close-save-btn-text').textContent = lang.modalCloseSave;
            
            displayFileList();
        }

        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            localStorage.setItem('jsonCleanerLang', currentLang);
            updateLanguageUI();
        }

        langToggleBtn.addEventListener('click', toggleLanguage);
        
        // --- وظائف الواجهة الرئيسية ---
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('border-blue-500', 'bg-blue-50'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('border-blue-500', 'bg-blue-50'));
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('border-blue-500', 'bg-blue-50'); handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
            uploadedFiles = Array.from(files).filter(file => file.type === 'application/json');
            if (uploadedFiles.length > 0) {
                resultsArea.classList.remove('hidden');
                uploadPrompt.classList.add('hidden');
                displayFileList();
                processBtn.disabled = false;
                validateBtn.disabled = true;
                downloadBtn.disabled = true;
            } else {
                alert(translations[currentLang].alertOnlyJson);
            }
        }

        function displayFileList() {
            fileList.innerHTML = '';
            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.id = `file-item-${index}`;
                fileItem.className = 'file-list-item flex items-center justify-between bg-gray-100 p-3 rounded-lg';
                const statusSpan = document.createElement('span');
                statusSpan.id = `status-${index}`;
                statusSpan.className = 'text-sm font-semibold text-gray-500';
                statusSpan.textContent = translations[currentLang].readyStatus;
                
                const fileNameSpan = document.createElement('span');
                fileNameSpan.className = 'text-gray-800 truncate';
                fileNameSpan.textContent = file.name;

                fileItem.appendChild(fileNameSpan);
                fileItem.appendChild(statusSpan);
                fileList.appendChild(fileItem);
            });
        }

        // --- وظيفة تنظيف الإجابات ---
        function cleanJson(jsonContent, fileName) {
            try {
                const data = JSON.parse(jsonContent);
                const results = [];
                let wasAnyFileCleaned = false;

                if (data.parts && Array.isArray(data.parts)) {
                    data.parts.forEach((part, partIndex) => {
                        if (part.type === 'string' && part.answer && Array.isArray(part.answer) && part.answer.length > 0) {
                            const originalAnswer = part.answer[0]; // نفترض إجابة واحدة فقط
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(originalAnswer, 'text/html');
                            const cleanedAnswer = doc.body.textContent || "";
                            
                            if (originalAnswer !== cleanedAnswer) {
                                results.push({
                                    fileName: fileName,
                                    partIndex: partIndex,
                                    originalAnswer: originalAnswer,
                                    cleanedAnswer: cleanedAnswer,
                                    finalJsonContent: '' // سيتم تحديثه لاحقًا
                                });
                                part.answer = [cleanedAnswer]; // تحديث البيانات
                                wasAnyFileCleaned = true;
                            }
                        }
                    });
                }
                return { finalData: data, results, wasAnyFileCleaned, error: null };
            } catch (error) {
                console.error("Error parsing or cleaning JSON:", error);
                return { error: translations[currentLang].invalidJsonError };
            }
        }

        // --- معالجة الملفات ---
        processBtn.addEventListener('click', async () => {
            processBtn.disabled = true;
            validateBtn.disabled = true;
            downloadBtn.disabled = true;
            processingIndicator.classList.remove('hidden');
            document.getElementById('processing-indicator-text').textContent = translations[currentLang].processingStatus;
            processedFilesData = [];
            
            const processingPromises = uploadedFiles.map((file, index) => {
                const statusEl = document.getElementById(`status-${index}`);
                statusEl.textContent = translations[currentLang].processingFileStatus;
                statusEl.className = 'text-sm font-semibold text-yellow-500';

                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const { finalData, results, wasAnyFileCleaned, error } = cleanJson(e.target.result, file.name);
                        if (error) {
                            statusEl.textContent = `${translations[currentLang].errorStatus}: ${error}`;
                            statusEl.className = 'text-sm font-semibold text-red-500';
                        } else {
                            const finalJsonContent = JSON.stringify(finalData, null, 2);
                            results.forEach(r => r.finalJsonContent = finalJsonContent);
                            processedFilesData.push(...results);
                            
                            statusEl.textContent = wasAnyFileCleaned ? translations[currentLang].cleanedStatus : translations[currentLang].noChangesStatus;
                            statusEl.className = `text-sm font-semibold ${wasAnyFileCleaned ? 'text-green-500' : 'text-blue-500'}`;
                        }
                        resolve();
                    };
                    reader.readAsText(file);
                });
            });

            await Promise.all(processingPromises);
            
            document.getElementById('processing-indicator-text').textContent = translations[currentLang].processingComplete;
            processBtn.disabled = false;
            if (processedFilesData.length > 0) {
                validateBtn.disabled = false;
            }
            downloadBtn.disabled = false;
        });

        // --- وظائف شاشة المراجعة ---
        validateBtn.addEventListener('click', () => {
            renderValidationTable();
            validationModal.classList.remove('hidden');
            validationModal.classList.add('flex');
        });

        closeModalBtn.addEventListener('click', () => {
            validationModal.classList.add('hidden');
            validationModal.classList.remove('flex');
        });
        
        modalCloseSaveBtn.addEventListener('click', () => {
             validationModal.classList.add('hidden');
            validationModal.classList.remove('flex');
        });

        function renderValidationTable() {
            validationTableBody.innerHTML = '';
            processedFilesData.forEach((data, index) => {
                const row = document.createElement('tr');
                row.className = 'modal-row border-b hover:bg-gray-50';
                
                const isInvalid = !data.cleanedAnswer || data.cleanedAnswer.trim() === 'null' || data.cleanedAnswer.trim() === '';
                
                row.innerHTML = `
                    <td class="p-3 text-gray-800">${data.fileName}</td>
                    <td class="p-3 text-gray-600 font-mono text-sm">${escapeHtml(data.originalAnswer)}</td>
                    <td class="p-3">
                        <input type="text" value="${escapeHtml(data.cleanedAnswer)}" 
                               data-index="${index}" 
                               class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition-all ${isInvalid ? 'bg-red-100 border-red-400 text-red-800' : 'border-gray-300'}">
                    </td>
                `;
                validationTableBody.appendChild(row);
            });
        }
        
        validationTableBody.addEventListener('input', (e) => {
            if (e.target.tagName === 'INPUT' && e.target.dataset.index) {
                const index = parseInt(e.target.dataset.index, 10);
                const newData = processedFilesData[index];
                const newAnswer = e.target.value;

                // تحديث القيمة في مصفوفة البيانات
                newData.cleanedAnswer = newAnswer;

                // إعادة بناء ملف JSON بالكامل مع الإجابة المعدلة
                try {
                    const fullJson = JSON.parse(uploadedFiles.find(f => f.name === newData.fileName)._originalContent);
                    fullJson.parts[newData.partIndex].answer = [newAnswer];
                    newData.finalJsonContent = JSON.stringify(fullJson, null, 2);
                } catch (err) {
                    console.error("Failed to update JSON content after edit:", err);
                }
                
                // تحديث التنسيق البصري
                 const isInvalid = !newAnswer || newAnswer.trim() === 'null' || newAnswer.trim() === '';
                 e.target.classList.toggle('bg-red-100', isInvalid);
                 e.target.classList.toggle('border-red-400', isInvalid);
                 e.target.classList.toggle('text-red-800', isInvalid);
                 e.target.classList.toggle('border-gray-300', !isInvalid);
            }
        });
        
        // --- تحميل الملفات ---
        downloadBtn.addEventListener('click', () => {
            const finalZip = new JSZip();
            const finalFiles = {};

            // تجميع كل التعديلات لكل ملف
            processedFilesData.forEach(data => {
                finalFiles[data.fileName] = data.finalJsonContent;
            });
            
            // إضافة الملفات التي لم يتم تعديلها
            uploadedFiles.forEach(file => {
                if (!finalFiles[file.name]) {
                    finalFiles[file.name] = file._originalContent;
                }
            });

            // إضافة كل الملفات النهائية إلى الـ ZIP
            for (const fileName in finalFiles) {
                finalZip.file(fileName, finalFiles[fileName]);
            }

            finalZip.generateAsync({ type: "blob" })
                .then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = "cleaned_and_validated_files.zip";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                });
        });

        // --- وظائف مساعدة ---
        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }
        
        // تعديل بسيط لحفظ المحتوى الأصلي للملفات عند الرفع
         function handleFiles(files) {
            uploadedFiles = Array.from(files).filter(file => file.type === 'application/json');
            
            const readPromises = uploadedFiles.map(file => {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        file._originalContent = e.target.result;
                        resolve();
                    };
                    reader.readAsText(file);
                });
            });

            Promise.all(readPromises).then(() => {
                if (uploadedFiles.length > 0) {
                    resultsArea.classList.remove('hidden');
                    uploadPrompt.classList.add('hidden');
                    displayFileList();
                    processBtn.disabled = false;
                    validateBtn.disabled = true;
                    downloadBtn.disabled = true;
                } else {
                    alert(translations[currentLang].alertOnlyJson);
                }
            });
        }


        // --- تشغيل اللغة عند بدء التشغيل ---
        updateLanguageUI();
    </script>

</body>
</html>
